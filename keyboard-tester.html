<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ†ã‚¹ã‚¿ãƒ¼ - gohanda_kbd</title>
    <link rel="icon" type="image/png" href="image/icon/gohanda.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">
                    <h1>gohanda_kbd</h1>
                </div>
                <div class="nav-links">
                    <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
                    <a href="keyboard-tester.html" class="active">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ†ã‚¹ã‚¿ãƒ¼</a>
                </div>
            </nav>
            <div class="hero">
                <h2>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ†ã‚¹ã‚¿ãƒ¼</h2>
                <p>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®å‹•ä½œç¢ºèªã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤º</p>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="tester-controls">
            <div class="control-group">
                <label for="keyboard-select">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’é¸æŠ:</label>
                <div class="select-with-button">
                    <select id="keyboard-select">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="soa44">Soa44</option>
                        <option value="soa39">Soa39</option>
                    </select>
                    <button id="open-custom-dialog" class="custom-button" title="ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰èª­ã¿è¾¼ã¿">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div id="layer-controls" class="layer-controls" style="display: none;">
                <label>ãƒ¬ã‚¤ãƒ¤ãƒ¼:</label>
                <div class="layer-buttons-row">
                    <div id="layer-buttons" class="layer-buttons"></div>
                    <button id="open-trackball-test" class="trackball-test-button" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
                            <circle cx="10" cy="10" r="3" fill="currentColor"/>
                        </svg>
                        ãƒˆãƒ©ãƒƒã‚¯ãƒœãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ
                    </button>
                </div>
                <div class="current-layer-info">
                    <span id="current-layer-name">Layer 0: Default</span>
                </div>
            </div>

            <div id="loading-status" class="loading-status"></div>
        </section>

        <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒã‚¸ãƒˆãƒªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
        <div id="custom-dialog" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰èª­ã¿è¾¼ã¿</h3>
                    <button id="close-dialog" class="close-button">&times;</button>
                </div>
                <form autocomplete="off" data-form-type="other">
                    <div class="modal-body">
                        <div class="input-row">
                            <label for="keymap-url">.keymap ãƒ•ã‚¡ã‚¤ãƒ«ã®URL:</label>
                            <input type="url" id="keymap-url" name="keymap-url" placeholder="https://github.com/username/repo/blob/main/config/keyboard.keymap" autocomplete="url" spellcheck="false" data-lpignore="true" data-form-type="other">
                            <small>ã‚­ãƒ¼ãƒãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«(.keymap)ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆé€šå¸¸ã®GitHub URLã¾ãŸã¯raw URLï¼‰</small>
                        </div>
                        <div class="input-row">
                            <label for="layout-url">.json ãƒ•ã‚¡ã‚¤ãƒ«ã®URL:</label>
                            <input type="url" id="layout-url" name="layout-url" placeholder="https://github.com/username/repo/blob/main/config/keyboard.json" autocomplete="url" spellcheck="false" data-lpignore="true" data-form-type="other">
                            <small>ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ•ã‚¡ã‚¤ãƒ«(.json)ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆé€šå¸¸ã®GitHub URLã¾ãŸã¯raw URLï¼‰</small>
                        </div>
                    </div>
                </form>
                <div class="modal-footer">
                    <button id="cancel-custom" class="cancel-button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button id="load-custom" class="load-button">èª­ã¿è¾¼ã¿</button>
                </div>
            </div>
        </div>

        <section id="keyboard-display" class="keyboard-display" style="display: none;">
            <div id="keyboard-visual" class="keyboard-visual"></div>
        </section>

        <!-- ãƒˆãƒ©ãƒƒã‚¯ãƒœãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
        <div id="trackball-popup" class="trackball-popup" style="display: none;">
            <div class="trackball-popup-content">
                <div class="trackball-popup-header">
                    <h3>ãƒˆãƒ©ãƒƒã‚¯ãƒœãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ</h3>
                    <button id="close-trackball-popup" class="close-popup-button">&times;</button>
                </div>
                <div class="trackball-popup-body">
                    <div class="trackball-container">
                        <div class="trackball-section">
                            <h4>ã‚«ãƒ¼ã‚½ãƒ«æ“ä½œ</h4>
                            <div class="trackball-visual" id="cursor-test-area">
                                <div class="cursor-indicator" id="cursor-indicator"></div>
                                <div class="center-marker"></div>
                            </div>
                            <div class="trackball-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Xç§»å‹•é‡:</span>
                                    <span class="stat-value" id="cursor-x">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Yç§»å‹•é‡:</span>
                                    <span class="stat-value" id="cursor-y">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ç·ç§»å‹•é‡:</span>
                                    <span class="stat-value" id="cursor-total">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="trackball-section">
                            <h4>ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ“ä½œ</h4>
                            <div class="scroll-visual">
                                <div class="scroll-indicator-horizontal">
                                    <div class="scroll-arrow left" id="scroll-left">â†</div>
                                    <div class="scroll-indicator-vertical">
                                        <div class="scroll-arrow up" id="scroll-up">â†‘</div>
                                        <div class="scroll-center"></div>
                                        <div class="scroll-arrow down" id="scroll-down">â†“</div>
                                    </div>
                                    <div class="scroll-arrow right" id="scroll-right">â†’</div>
                                </div>
                            </div>
                            <div class="trackball-stats">
                                <div class="stat-item">
                                    <span class="stat-label">ä¸Šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«:</span>
                                    <span class="stat-value" id="scroll-up-count">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ä¸‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«:</span>
                                    <span class="stat-value" id="scroll-down-count">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å·¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«:</span>
                                    <span class="stat-value" id="scroll-left-count">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«:</span>
                                    <span class="stat-value" id="scroll-right-count">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="reset-trackball" class="reset-button">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>

        <section class="tester-info">
            <h3>ä½¿ã„æ–¹</h3>
            <ul>
                <li>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’é¸æŠã™ã‚‹ã¨ã€ã”ã¯ã‚“ã ã®GitHubã‹ã‚‰è‡ªå‹•çš„ã«ã‚­ãƒ¼ãƒãƒƒãƒ—ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã™</li>
                <li>ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹æ¨ªã®<strong>+ãƒœã‚¿ãƒ³</strong>ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã‚«ã‚¹ã‚¿ãƒ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚ã¾ã™
                    <ul style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
                        <li>.keymapãƒ•ã‚¡ã‚¤ãƒ«ã¨.jsonãƒ•ã‚¡ã‚¤ãƒ«ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</li>
                        <li>GitHubã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒšãƒ¼ã‚¸URLã¾ãŸã¯raw URLã©ã¡ã‚‰ã§ã‚‚ä½¿ç”¨ã§ãã¾ã™</li>
                        <li>ä¾‹: https://github.com/username/repo/blob/main/config/keyboard.keymap</li>
                    </ul>
                </li>
                <li>ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚­ãƒ¼ãƒãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
                <li>å®Ÿéš›ã«ã‚­ãƒ¼ã‚’æŠ¼ã™ã¨ã€æŠ¼ã•ã‚ŒãŸã‚­ãƒ¼ãŒ<strong style="color: #228b22;">ç·‘è‰²</strong>ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã¾ã™</li>
                <li>æŠ¼ã—ãŸã‚­ãƒ¼ã¯å±¥æ­´ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã€<strong style="color: #4682b4;">æ°´è‰²</strong>ã§è¡¨ç¤ºã•ã‚Œã¾ã™</li>
            </ul>
            <div class="tester-legend">
                <div class="legend-item">
                    <div class="legend-key key-default">Key</div>
                    <span>æœªä½¿ç”¨ã®ã‚­ãƒ¼</span>
                </div>
                <div class="legend-item">
                    <div class="legend-key key-tested">Key</div>
                    <span>ãƒ†ã‚¹ãƒˆæ¸ˆã¿ã®ã‚­ãƒ¼</span>
                </div>
                <div class="legend-item">
                    <div class="legend-key key-pressing">Key</div>
                    <span>æŠ¼ã—ã¦ã„ã‚‹é–“</span>
                </div>
            </div>
            <div class="warning">
                <strong>æ³¨æ„:</strong> ã“ã®ãƒ†ã‚¹ã‚¿ãƒ¼ã¯å„ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚­ãƒ¼ãƒãƒƒãƒ—ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚å¤‰æ›´å¾Œã¯+ãƒœã‚¿ãƒ³ã‹ã‚‰URLã‚’å…¥åŠ›ã—èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 gohanda_kbd. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Chromeæ‹¡å¼µæ©Ÿèƒ½ã®ã‚¨ãƒ©ãƒ¼ã‚’æŠ‘åˆ¶
        window.addEventListener('error', (e) => {
            // ã‚¨ãƒ©ãƒ¼ã®ã‚½ãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆmessage, filename, error.stackãªã©ï¼‰
            const errorSource = e.filename || e.message || (e.error && e.error.stack) || '';
            if (errorSource.includes('chrome-extension://')) {
                e.stopImmediatePropagation();
                e.preventDefault();
                return true;
            }
        }, true);

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¨­å®š
        const keyboardConfigs = {
            soa44: {
                name: 'Soa44',
                keymapUrl: 'https://raw.githubusercontent.com/gohanda11/zmk-config-soa44/main/config/soa44.keymap',
                layoutUrl: 'https://raw.githubusercontent.com/gohanda11/zmk-config-soa44/main/config/soa44.json',
                layout: 'split',
                keys: 44
            },
            soa39: {
                name: 'Soa39mini',
                keymapUrl: 'https://raw.githubusercontent.com/gohanda11/zmk-config-soa39/main/config/soa39.keymap',
                layoutUrl: 'https://raw.githubusercontent.com/gohanda11/zmk-config-soa39/main/config/soa39.json',
                layout: 'split',
                keys: 39
            }
        };

        let currentKeyboard = null;
        let currentLayer = 0;
        let keymapData = null;
        let layoutData = null;
        let pressedKeys = new Set();
        let keyTimers = new Map(); // ã‚­ãƒ¼ã”ã¨ã®ã‚¿ã‚¤ãƒãƒ¼
        let holdThreshold = 200; // é•·æŠ¼ã—åˆ¤å®šæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
        let testHistory = new Set(); // ãƒ†ã‚¹ãƒˆæ¸ˆã¿ã‚­ãƒ¼ã®å±¥æ­´
        let customKeyboardData = null; // ã‚«ã‚¹ã‚¿ãƒ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜

        // ãƒˆãƒ©ãƒƒã‚¯ãƒœãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆç”¨ã®å¤‰æ•°
        let trackballEnabled = false;
        let trackballAvailable = false; // Soa44/Soa39ã§åˆ©ç”¨å¯èƒ½
        let cursorX = 0;
        let cursorY = 0;
        let cursorTotal = 0;
        let scrollUpCount = 0;
        let scrollDownCount = 0;
        let scrollLeftCount = 0;
        let scrollRightCount = 0;
        let scrollTotal = 0;
        let lastMouseMoveTime = 0;
        let mouseMovementThrottle = 16; // ç´„60fps

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é¸æŠ
        document.getElementById('keyboard-select').addEventListener('change', async (e) => {
            const selectedKeyboard = e.target.value;
            if (!selectedKeyboard) {
                document.getElementById('layer-controls').style.display = 'none';
                document.getElementById('keyboard-display').style.display = 'none';
                document.getElementById('open-trackball-test').style.display = 'none';
                trackballAvailable = false;
                return;
            }

            // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰
            if (keyboardConfigs[selectedKeyboard]) {
                currentKeyboard = keyboardConfigs[selectedKeyboard];
                await loadKeyboardData(currentKeyboard);

                // Soa44ã¨Soa39ã®å ´åˆã¯ãƒˆãƒ©ãƒƒã‚¯ãƒœãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                if (selectedKeyboard === 'soa44' || selectedKeyboard === 'soa39') {
                    trackballAvailable = true;
                    document.getElementById('open-trackball-test').style.display = 'inline-flex';
                } else {
                    trackballAvailable = false;
                    document.getElementById('open-trackball-test').style.display = 'none';
                }
            }
            // ã‚«ã‚¹ã‚¿ãƒ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰
            else if (selectedKeyboard.startsWith('custom_') && customKeyboardData) {
                currentKeyboard = customKeyboardData;
                await loadKeyboardData(currentKeyboard);
                trackballAvailable = false;
                document.getElementById('open-trackball-test').style.display = 'none';
            }
        });

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
        document.getElementById('open-custom-dialog').addEventListener('click', () => {
            document.getElementById('custom-dialog').style.display = 'flex';
        });

        // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        document.getElementById('close-dialog').addEventListener('click', () => {
            document.getElementById('custom-dialog').style.display = 'none';
        });

        document.getElementById('cancel-custom').addEventListener('click', () => {
            document.getElementById('custom-dialog').style.display = 'none';
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('custom-dialog').addEventListener('click', (e) => {
            if (e.target.id === 'custom-dialog') {
                document.getElementById('custom-dialog').style.display = 'none';
            }
        });

        // ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒã‚¸ãƒˆãƒªèª­ã¿è¾¼ã¿
        document.getElementById('load-custom').addEventListener('click', async () => {
            let keymapUrl = document.getElementById('keymap-url').value.trim();
            let layoutUrl = document.getElementById('layout-url').value.trim();

            if (!keymapUrl || !layoutUrl) {
                alert('.keymapã¨.jsonã®ä¸¡æ–¹ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // URLã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
            if (!keymapUrl.includes('.keymap')) {
                alert('.keymapãƒ•ã‚¡ã‚¤ãƒ«ã®URLãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            if (!layoutUrl.includes('.json')) {
                alert('.jsonãƒ•ã‚¡ã‚¤ãƒ«ã®URLãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // é€šå¸¸ã®GitHub URLã‚’raw URLã«è‡ªå‹•å¤‰æ›
            keymapUrl = convertToRawFileUrl(keymapUrl);
            layoutUrl = convertToRawFileUrl(layoutUrl);

            // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰åã‚’æŠ½å‡º
            const keymapFileName = keymapUrl.split('/').pop().replace('.keymap', '');
            const keyboardName = keymapFileName || 'custom';

            customKeyboardData = {
                name: keyboardName,
                keymapUrl: keymapUrl,
                layoutUrl: layoutUrl,
                layout: 'custom',
                keys: 0
            };

            currentKeyboard = customKeyboardData;

            // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
            document.getElementById('custom-dialog').style.display = 'none';

            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('keymap-url').value = '';
            document.getElementById('layout-url').value = '';

            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã¾ãŸã¯æ›´æ–°
            updateCustomOption(keyboardName);

            await loadKeyboardData(currentKeyboard);
        });

        // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        function updateCustomOption(keyboardName) {
            const select = document.getElementById('keyboard-select');

            // æ—¢å­˜ã®ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
            const existingCustom = select.querySelector('option[data-custom="true"]');
            if (existingCustom) {
                existingCustom.remove();
            }

            // æ–°ã—ã„ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            const option = document.createElement('option');
            option.value = `custom_${keyboardName}`;
            option.textContent = `${keyboardName} (ã‚«ã‚¹ã‚¿ãƒ )`;
            option.dataset.custom = 'true';
            option.selected = true;
            select.appendChild(option);
        }

        // GitHub URLã‚’raw URLã«å¤‰æ›ï¼ˆãƒªãƒã‚¸ãƒˆãƒªURLç”¨ï¼‰
        function convertToRawUrl(githubUrl) {
            // https://github.com/username/repo â†’ https://raw.githubusercontent.com/username/repo/main
            const match = githubUrl.match(/github\.com\/([^\/]+)\/([^\/]+)/);
            if (!match) return null;

            const username = match[1];
            const repo = match[2].replace(/\.git$/, ''); // .gitæ‹¡å¼µå­ã‚’å‰Šé™¤

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯mainãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ç”¨
            return `https://raw.githubusercontent.com/${username}/${repo}/main`;
        }

        // GitHub ãƒ•ã‚¡ã‚¤ãƒ«URLã‚’raw URLã«å¤‰æ›
        function convertToRawFileUrl(url) {
            // æ—¢ã«raw URLã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
            if (url.includes('raw.githubusercontent.com')) {
                return url;
            }

            // https://github.com/username/repo/blob/branch/path/file.ext
            // â†’ https://raw.githubusercontent.com/username/repo/branch/path/file.ext
            const match = url.match(/github\.com\/([^\/]+)\/([^\/]+)\/blob\/(.+)/);
            if (match) {
                const username = match[1];
                const repo = match[2];
                const pathWithBranch = match[3];
                return `https://raw.githubusercontent.com/${username}/${repo}/${pathWithBranch}`;
            }

            // å¤‰æ›ã§ããªã„å ´åˆã¯ãã®ã¾ã¾è¿”ã™
            return url;
        }

        // ã‚­ãƒ¼ãƒãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•æ¤œå‡ºï¼ˆãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’å†å¸°çš„ã«æ¤œç´¢ï¼‰
        async function autoDetectKeymapFiles(rawBaseUrl) {
            try {
                const repoMatch = rawBaseUrl.match(/githubusercontent\.com\/([^\/]+)\/([^\/]+)/);
                if (!repoMatch) return null;

                const username = repoMatch[1];
                const repo = repoMatch[2];

                // ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã‹ã‚‰å†å¸°çš„ã«æ¤œç´¢
                const foundFiles = await searchRepository(username, repo, '');

                if (!foundFiles) return null;

                return {
                    name: foundFiles.name,
                    keymapUrl: `https://raw.githubusercontent.com/${username}/${repo}/main/${foundFiles.keymapPath}`,
                    layoutUrl: `https://raw.githubusercontent.com/${username}/${repo}/main/${foundFiles.jsonPath}`
                };
            } catch (error) {
                console.error('Auto-detect error:', error);
                return null;
            }
        }

        // ãƒªãƒã‚¸ãƒˆãƒªã‚’å†å¸°çš„ã«æ¤œç´¢ï¼ˆã‚ˆãã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å„ªå…ˆï¼‰
        async function searchRepository(username, repo, path) {
            try {
                // ã¾ãšä¸€èˆ¬çš„ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å„ªå…ˆçš„ã«æ¤œç´¢
                const commonDirs = ['config', 'boards', 'keyboards', ''];

                // pathãŒç©ºã®å ´åˆã€ã‚ˆãã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å…ˆã«è©¦ã™
                if (path === '') {
                    for (const dir of commonDirs) {
                        const found = await searchInDirectory(username, repo, dir);
                        if (found) return found;
                    }
                    return null;
                }

                return await searchInDirectory(username, repo, path);
            } catch (error) {
                console.error('Search error:', error);
                return null;
            }
        }

        // ç‰¹å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã‚’æ¤œç´¢
        async function searchInDirectory(username, repo, path) {
            try {
                const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    // 403ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å¯èƒ½æ€§
                    if (response.status === 403) {
                        console.error('GitHub API rate limit exceeded');
                    }
                    return null;
                }

                const items = await response.json();

                // ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§keymapã¨jsonã®ãƒšã‚¢ã‚’æ¢ã™
                const keymapFiles = items.filter(item => item.type === 'file' && item.name.endsWith('.keymap'));

                for (const keymapFile of keymapFiles) {
                    const baseName = keymapFile.name.replace('.keymap', '');
                    const jsonFile = items.find(item =>
                        item.type === 'file' && item.name === `${baseName}.json`
                    );

                    if (jsonFile) {
                        // ãƒšã‚¢ãŒè¦‹ã¤ã‹ã£ãŸ
                        return {
                            name: baseName,
                            keymapPath: keymapFile.path,
                            jsonPath: jsonFile.path
                        };
                    }
                }

                // ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¤œç´¢ï¼ˆæ·±ã•åˆ¶é™ã‚’è¿½åŠ ï¼‰
                const pathDepth = path.split('/').filter(p => p).length;
                if (pathDepth < 3) {  // æœ€å¤§3éšå±¤ã¾ã§
                    const directories = items.filter(item => item.type === 'dir');
                    for (const dir of directories) {
                        const found = await searchInDirectory(username, repo, dir.path);
                        if (found) return found;
                    }
                }

                return null;
            } catch (error) {
                console.error('Search in directory error:', error);
                return null;
            }
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ¼ãƒãƒƒãƒ— + ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰
        async function loadKeyboardData(keyboard) {
            const statusDiv = document.getElementById('loading-status');
            statusDiv.textContent = 'ã‚­ãƒ¼ãƒãƒƒãƒ—ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...';
            statusDiv.className = 'loading-status loading';

            try {
                // ã‚­ãƒ¼ãƒãƒƒãƒ—ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¸¦è¡Œå–å¾—
                const [keymapResponse, layoutResponse] = await Promise.all([
                    fetch(keyboard.keymapUrl),
                    fetch(keyboard.layoutUrl)
                ]);

                if (!keymapResponse.ok) throw new Error('ã‚­ãƒ¼ãƒãƒƒãƒ—ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                if (!layoutResponse.ok) throw new Error('ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');

                const keymapText = await keymapResponse.text();
                const layoutJson = await layoutResponse.json();

                keymapData = parseZmkKeymap(keymapText);

                // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆè¤‡æ•°ã®å½¢å¼ã«å¯¾å¿œï¼‰
                if (layoutJson.layouts.default_layout) {
                    layoutData = layoutJson.layouts.default_layout.layout;
                } else if (layoutJson.layouts.LAYOUT) {
                    layoutData = layoutJson.layouts.LAYOUT.layout;
                } else {
                    // æœ€åˆã«è¦‹ã¤ã‹ã£ãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä½¿ç”¨
                    const firstLayoutKey = Object.keys(layoutJson.layouts)[0];
                    layoutData = layoutJson.layouts[firstLayoutKey].layout;
                }

                statusDiv.textContent = '';
                statusDiv.className = 'loading-status';

                setupLayerControls();
                renderKeyboard();
            } catch (error) {
                statusDiv.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                statusDiv.className = 'loading-status error';
            }
        }

        // ZMKã‚­ãƒ¼ãƒãƒƒãƒ—ãƒ‘ãƒ¼ã‚µãƒ¼(æ”¹å–„ç‰ˆ)
        function parseZmkKeymap(text) {
            const layers = [];
            const layerNames = [];

            // keymapãƒ–ãƒ­ãƒƒã‚¯å…¨ä½“ã‚’æŠ½å‡ºï¼ˆæœ€å¾Œã®é–‰ã˜æ‹¬å¼§ã¾ã§ï¼‰
            const keymapMatch = text.match(/keymap\s*\{([\s\S]*)\n\s*\};/);
            if (!keymapMatch) {
                console.error('keymapãƒ–ãƒ­ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                throw new Error('ã‚­ãƒ¼ãƒãƒƒãƒ—ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            const keymapContent = keymapMatch[1];
            console.log('Keymap content length:', keymapContent.length);
            console.log('First 500 chars of keymap:', keymapContent.substring(0, 500));

            // å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡ºï¼ˆæ”¹å–„ç‰ˆï¼šãƒã‚¹ãƒˆã—ãŸæ‹¬å¼§ã«å¯¾å¿œï¼‰
            const layerRegex = /(\w+)\s*\{/g;
            let match;
            let matchCount = 0;

            const layerMatches = [];

            // ã™ã¹ã¦ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼é–‹å§‹ä½ç½®ã‚’è¦‹ã¤ã‘ã‚‹
            while ((match = layerRegex.exec(keymapContent)) !== null) {
                layerMatches.push({
                    name: match[1],
                    startIndex: match.index,
                    startBraceIndex: match.index + match[0].length - 1
                });
            }

            // å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡º
            for (let i = 0; i < layerMatches.length; i++) {
                const currentLayer = layerMatches[i];
                const nextLayerStart = i < layerMatches.length - 1 ? layerMatches[i + 1].startIndex : keymapContent.length;

                // æ‹¬å¼§ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã£ã¦ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ã®çµ‚ã‚ã‚Šã‚’è¦‹ã¤ã‘ã‚‹
                const layerContent = keymapContent.substring(currentLayer.startBraceIndex, nextLayerStart);
                const endIndex = findMatchingBrace(layerContent);

                if (endIndex === -1) continue;

                const fullLayerContent = layerContent.substring(0, endIndex);

                // bindingséƒ¨åˆ†ã‚’æŠ½å‡º
                const bindingsMatch = fullLayerContent.match(/bindings\s*=\s*<([\s\S]*?)>\s*;/);
                if (!bindingsMatch) continue;

                const layerName = currentLayer.name;
                const bindingsText = bindingsMatch[1];
                matchCount++;

                console.log(`Layer ${matchCount}: ${layerName}, bindings length: ${bindingsText.length}`);

                // compatible, template, ä¸è¦ãªãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
                if (layerName === 'compatible' || layerName === 'template') continue;

                layerNames.push(layerName);

                // ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãƒ‘ãƒ¼ã‚¹
                const cleanText = bindingsText
                    .replace(/\/\*[\s\S]*?\*\//g, '') // ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤
                    .replace(/\/\/.*/g, ''); // è¡Œã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤

                // æ­£è¦è¡¨ç¾ã§&ã‹ã‚‰å§‹ã¾ã‚‹å®Œå…¨ãªãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’æŠ½å‡º
                const bindingRegex = /&\w+(?:\s+[\w_]+)*(?:\s+[\w_]+)*/g;
                const bindingMatches = cleanText.match(bindingRegex) || [];

                const bindings = bindingMatches.map(b => parseBinding(b.trim()));

                console.log(`  Parsed ${bindings.length} bindings`);
                if (layerName === 'default' && bindings.length > 0) {
                    console.log('First 5 bindings of default layer:');
                    bindings.slice(0, 5).forEach((b, i) => {
                        console.log(`  [${i}] type: ${b.type}, key: ${b.key}, raw: ${b.raw}`);
                    });
                }
                layers.push(bindings);
            }

            // æ‹¬å¼§ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹é–¢æ•°
            function findMatchingBrace(text) {
                let depth = 1;
                for (let i = 1; i < text.length; i++) {
                    if (text[i] === '{') depth++;
                    else if (text[i] === '}') {
                        depth--;
                        if (depth === 0) return i;
                    }
                }
                return -1;
            }

            console.log(`Total layers found: ${layers.length}`);
            console.log('Layer names:', layerNames);

            if (layers.length === 0) {
                throw new Error('ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }

            return {
                layers: layers,
                layerNames: layerNames
            };
        }

        // ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãƒ‘ãƒ¼ã‚¹
        function parseBinding(binding) {
            // &lt ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¿ãƒƒãƒ— (ä¾‹: &lt 3 SPACE, &lt 6 DELETE)
            const ltMatch = binding.match(/&lt\s+(\d+)\s+([\w_]+)/);
            if (ltMatch) {
                return {
                    type: 'layer-tap',
                    layer: parseInt(ltMatch[1]),
                    key: formatKeycode(ltMatch[2]),
                    raw: binding
                };
            }

            // &mo ãƒ¢ãƒ¼ãƒ¡ãƒ³ã‚¿ãƒªãƒ¬ã‚¤ãƒ¤ãƒ¼
            const moMatch = binding.match(/&mo\s+(\d+)/);
            if (moMatch) {
                return {
                    type: 'momentary',
                    layer: parseInt(moMatch[1]),
                    key: `MO(${moMatch[1]})`,
                    raw: binding
                };
            }

            // &mt ãƒ¢ãƒƒãƒ‰ã‚¿ãƒƒãƒ— (ä¾‹: &mt LCTRL TAB)
            const mtMatch = binding.match(/&mt\s+([\w_]+)\s+([\w_]+)/);
            if (mtMatch) {
                return {
                    type: 'mod-tap',
                    key: `${formatKeycode(mtMatch[2])}`,
                    mod: formatKeycode(mtMatch[1]),
                    raw: binding
                };
            }

            // &kp é€šå¸¸ã‚­ãƒ¼ (ä¾‹: &kp ESCAPE, &kp LEFT_SHIFT)
            const kpMatch = binding.match(/&kp\s+([\w_]+)/);
            if (kpMatch) {
                return {
                    type: 'keypress',
                    key: formatKeycode(kpMatch[1]),
                    raw: binding
                };
            }

            // &mkp ãƒã‚¦ã‚¹ã‚­ãƒ¼ (ä¾‹: &mkp MB1)
            const mkpMatch = binding.match(/&mkp\s+([\w_]+)/);
            if (mkpMatch) {
                return {
                    type: 'mouse-key',
                    key: formatKeycode(mkpMatch[1]),
                    raw: binding
                };
            }

            // &trans é€é
            if (binding.includes('&trans')) {
                return { type: 'trans', key: 'â–½', raw: binding };
            }

            // &none ãªã—
            if (binding.includes('&none')) {
                return { type: 'none', key: 'âœ•', raw: binding };
            }

            // ãã®ä»–
            return { type: 'other', key: binding.replace(/^&/, ''), raw: binding };
        }

        // ã‚­ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatKeycode(code) {
            const keyMap = {
                'SPACE': 'Space',
                'ENTER': 'Enter',
                'RET': 'Enter',
                'BSPC': 'BS',
                'BACKSPACE': 'BS',
                'TAB': 'Tab',
                'ESC': 'Esc',
                'ESCAPE': 'Esc',
                'DELETE': 'Del',
                'DEL': 'Del',
                'LEFT_SHIFT': 'LShift',
                'RIGHT_SHIFT': 'RShift',
                'LSHIFT': 'LShift',
                'RSHIFT': 'RShift',
                'LSHFT': 'LShift',
                'RSHFT': 'RShift',
                'LEFT_CONTROL': 'LCtrl',
                'RIGHT_CONTROL': 'RCtrl',
                'LCTRL': 'LCtrl',
                'RCTRL': 'RCtrl',
                'LCTL': 'LCtrl',
                'RCTL': 'RCtrl',
                'LEFT_ALT': 'LAlt',
                'RIGHT_ALT': 'RAlt',
                'LALT': 'LAlt',
                'RALT': 'RAlt',
                'LEFT_WIN': 'LWin',
                'RIGHT_WIN': 'RWin',
                'LGUI': 'LCmd',
                'RGUI': 'RCmd',
                'UP': 'â†‘',
                'DOWN': 'â†“',
                'LEFT': 'â†',
                'RIGHT': 'â†’',
                'UP_ARROW': 'â†‘',
                'DOWN_ARROW': 'â†“',
                'LEFT_ARROW': 'â†',
                'RIGHT_ARROW': 'â†’',
                'MINUS': '-',
                'EQUAL': '=',
                'LEFT_BRACKET': '[',
                'RIGHT_BRACKET': ']',
                'LBKT': '[',
                'RBKT': ']',
                'BACKSLASH': '\\',
                'BSLH': '\\',
                'PIPE': '|',
                'SEMICOLON': ';',
                'SEMI': ';',
                'SINGLE_QUOTE': "'",
                'SQT': "'",
                'APOSTROPHE': "'",
                'GRAVE': '`',
                'COMMA': ',',
                'PERIOD': '.',
                'DOT': '.',
                'SLASH': '/',
                'FSLH': '/',
                'EXCLAMATION': '!',
                'EXCL': '!',
                'AT_SIGN': '@',
                'AT': '@',
                'HASH': '#',
                'POUND': '#',
                'DOLLAR': '$',
                'DLLR': '$',
                'PERCENT': '%',
                'PRCNT': '%',
                'CARET': '^',
                'AMPERSAND': '&',
                'AMPS': '&',
                'ASTERISK': '*',
                'ASTRK': '*',
                'STAR': '*',
                'LEFT_PARENTHESIS': '(',
                'RIGHT_PARENTHESIS': ')',
                'LPAR': '(',
                'RPAR': ')',
                'LEFT_BRACE': '{',
                'RIGHT_BRACE': '}',
                'DOUBLE_QUOTES': '"',
                'LANGUAGE_1': 'Lang1',
                'LANGUAGE_2': 'Lang2',
                'INT_MUHENKAN': 'ç„¡å¤‰æ›',
                // ãƒã‚¦ã‚¹ã‚­ãƒ¼
                'MB1': 'M1',
                'MB2': 'M2',
                'MB3': 'M3',
            };

            // ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚­ãƒ¼
            if (code.match(/^F\d+$/)) return code;

            // æ•°å­—
            if (code.match(/^N\d$/)) return code.replace('N', '');

            // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ
            if (code.match(/^[A-Z]$/)) return code;

            return keyMap[code] || code;
        }

        // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupLayerControls() {
            const layerControlsDiv = document.getElementById('layer-controls');
            const layerButtonsDiv = document.getElementById('layer-buttons');

            layerButtonsDiv.innerHTML = '';
            keymapData.layers.forEach((_, index) => {
                const button = document.createElement('button');
                button.textContent = index;
                button.className = index === 0 ? 'layer-button active' : 'layer-button';
                button.onclick = () => switchLayer(index);
                layerButtonsDiv.appendChild(button);
            });

            layerControlsDiv.style.display = 'block';
            updateLayerName();
        }

        // ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        function switchLayer(layerIndex) {
            currentLayer = layerIndex;

            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.layer-button').forEach((btn, index) => {
                btn.className = index === layerIndex ? 'layer-button active' : 'layer-button';
            });

            updateLayerName();
            renderKeyboard();
        }

        // ãƒ¬ã‚¤ãƒ¤ãƒ¼åæ›´æ–°
        function updateLayerName() {
            const layerName = keymapData.layerNames[currentLayer] || `Layer ${currentLayer}`;
            document.getElementById('current-layer-name').textContent = `Layer ${currentLayer}: ${layerName}`;
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æç”»
        function renderKeyboard() {
            const visualDiv = document.getElementById('keyboard-visual');
            const displaySection = document.getElementById('keyboard-display');

            visualDiv.innerHTML = '';

            const layerBindings = keymapData.layers[currentLayer];
            if (!layerBindings || !layoutData) return;

            // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦çµ¶å¯¾é…ç½®ã§ã‚­ãƒ¼ã‚’æç”»
            const keySize = 50; // 1ã‚­ãƒ¼å˜ä½ã®ã‚µã‚¤ã‚ºï¼ˆpxï¼‰

            // ã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
            const maxX = Math.max(...layoutData.map(k => k.x + (k.w || 1)));
            const maxY = Math.max(...layoutData.map(k => k.y)) + 1;

            visualDiv.style.position = 'relative';
            visualDiv.style.width = `${maxX * keySize}px`;
            visualDiv.style.height = `${maxY * keySize}px`;
            visualDiv.style.margin = '0 auto';

            // å„ã‚­ãƒ¼ã‚’é…ç½®
            layoutData.forEach((keyLayout, index) => {
                const binding = layerBindings[index];
                if (!binding) return;

                const keyDiv = document.createElement('div');
                keyDiv.className = 'key';
                keyDiv.dataset.keyIndex = index;
                keyDiv.dataset.layer = currentLayer;

                // ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’è¨­å®š
                const width = (keyLayout.w || 1) * keySize - 4; // 4px = gap
                const height = keySize - 4;
                const left = keyLayout.x * keySize;
                const top = keyLayout.y * keySize;

                keyDiv.style.position = 'absolute';
                keyDiv.style.left = `${left}px`;
                keyDiv.style.top = `${top}px`;
                keyDiv.style.width = `${width}px`;
                keyDiv.style.height = `${height}px`;
                keyDiv.style.minWidth = `${width}px`;
                keyDiv.style.minHeight = `${height}px`;

                // ã‚­ãƒ¼å†…å®¹ã‚’æ§‹ç¯‰
                buildKeyContent(keyDiv, binding);

                visualDiv.appendChild(keyDiv);
            });

            displaySection.style.display = 'block';
        }

        // ã‚­ãƒ¼å†…å®¹ã‚’æ§‹ç¯‰
        function buildKeyContent(keyDiv, binding) {
            // ãƒ¡ã‚¤ãƒ³ãƒ©ãƒ™ãƒ«ï¼ˆå¤§ããè¡¨ç¤ºã™ã‚‹ã‚­ãƒ¼ï¼‰
            const mainLabel = document.createElement('div');
            mainLabel.className = 'key-main-label';

            // ä¸Šéƒ¨ãƒ©ãƒ™ãƒ«ï¼ˆä¿®é£¾ã‚­ãƒ¼ã‚„è¿½åŠ æƒ…å ±ï¼‰
            const topLabel = document.createElement('div');
            topLabel.className = 'key-top-label';

            // ä¸‹éƒ¨ãƒ©ãƒ™ãƒ«ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ãªã©ï¼‰
            const bottomLabel = document.createElement('div');
            bottomLabel.className = 'key-bottom-label';

            switch (binding.type) {
                case 'keypress':
                    // é€šå¸¸ã‚­ãƒ¼: &kp Q â†’ Q
                    mainLabel.textContent = binding.key;
                    break;

                case 'mod-tap':
                    // ãƒ¢ãƒƒãƒ‰ã‚¿ãƒƒãƒ—: &mt LCTRL TAB â†’ ä¸Šéƒ¨ã«Ctrlã€ãƒ¡ã‚¤ãƒ³ã«Tab
                    topLabel.textContent = binding.mod;
                    mainLabel.textContent = binding.key;
                    break;

                case 'layer-tap':
                    // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¿ãƒƒãƒ—: &lt 3 SPACE â†’ ãƒ¡ã‚¤ãƒ³ã«Spaceã€ä¸‹éƒ¨ã«L3
                    mainLabel.textContent = binding.key;
                    bottomLabel.textContent = `L${binding.layer}`;
                    break;

                case 'momentary':
                    // ãƒ¢ãƒ¼ãƒ¡ãƒ³ã‚¿ãƒª: &mo 2 â†’ MO(2)
                    mainLabel.textContent = `MO(${binding.layer})`;
                    break;

                case 'trans':
                    // é€éã‚­ãƒ¼
                    mainLabel.textContent = 'â–½';
                    mainLabel.style.opacity = '0.5';
                    break;

                case 'none':
                    // ãªã—
                    mainLabel.textContent = 'âœ•';
                    mainLabel.style.opacity = '0.3';
                    break;

                case 'mouse-key':
                    // ãƒã‚¦ã‚¹ã‚­ãƒ¼
                    mainLabel.textContent = binding.key;
                    topLabel.textContent = 'ğŸ–±';
                    break;

                default:
                    // ãã®ä»–
                    mainLabel.textContent = binding.key;
                    break;
            }

            // è¦ç´ ã‚’è¿½åŠ 
            if (topLabel.textContent) keyDiv.appendChild(topLabel);
            keyDiv.appendChild(mainLabel);
            if (bottomLabel.textContent) keyDiv.appendChild(bottomLabel);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã™
        document.getElementById('keyboard-select').addEventListener('change', function() {
            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é¸æŠå¾Œã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’bodyã«ç§»å‹•ã—ã¦ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
            this.blur();
        });

        // ã‚­ãƒ¼æŠ¼ä¸‹ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('keydown', (e) => {
            if (!keymapData) return;

            // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã¯é™¤å¤–
            if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }

            // ä¿®é£¾ã‚­ãƒ¼ã¨ã®çµ„ã¿åˆã‚ã›ã§ã‚­ãƒ¼ã‚’è­˜åˆ¥
            let keyCode = e.code;

            // Shiftã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è¨˜å·ã‚­ãƒ¼ã¨ã—ã¦æ‰±ã†
            if (e.shiftKey && !e.code.startsWith('Shift')) {
                keyCode = 'Shift+' + e.code;
            }

            // æ—¢ã«æŠ¼ä¸‹æ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (pressedKeys.has(keyCode)) return;

            // Winã‚­ãƒ¼ã®ã¿ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’é˜²æ­¢
            if (e.key === 'Meta' || e.key === 'OS') {
                e.preventDefault();
            }

            pressedKeys.add(keyCode);

            // ãƒ†ã‚¹ãƒˆæ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯
            testHistory.add(keyCode);

            // ã‚­ãƒ¼ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            highlightKey(keyCode, true);
        });

        document.addEventListener('keyup', (e) => {
            if (!keymapData) return;

            // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã¯é™¤å¤–
            if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }

            // ä¿®é£¾ã‚­ãƒ¼ã¨ã®çµ„ã¿åˆã‚ã›ã§ã‚­ãƒ¼ã‚’è­˜åˆ¥
            let keyCode = e.code;

            // Shiftã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è¨˜å·ã‚­ãƒ¼ã¨ã—ã¦æ‰±ã†
            if (e.shiftKey && !e.code.startsWith('Shift')) {
                keyCode = 'Shift+' + e.code;
            }

            // Winã‚­ãƒ¼ã®ã¿ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’é˜²æ­¢
            if (e.key === 'Meta' || e.key === 'OS') {
                e.preventDefault();
            }

            pressedKeys.delete(keyCode);
            highlightKey(keyCode, false);
        });

        // ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('mousedown', (e) => {
            if (!keymapData) return;

            // ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ã‚’ã‚­ãƒ¼ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›
            const mouseButton = getMouseButtonCode(e.button);
            if (!mouseButton) return;

            // æ—¢ã«æŠ¼ä¸‹æ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (pressedKeys.has(mouseButton)) return;

            pressedKeys.add(mouseButton);
            testHistory.add(mouseButton);

            // ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            highlightKey(mouseButton, true);
        });

        document.addEventListener('mouseup', (e) => {
            if (!keymapData) return;

            const mouseButton = getMouseButtonCode(e.button);
            if (!mouseButton) return;

            pressedKeys.delete(mouseButton);
            highlightKey(mouseButton, false);
        });

        // ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ç•ªå·ã‚’ã‚­ãƒ¼ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›
        function getMouseButtonCode(button) {
            const buttonMap = {
                0: 'Mouse1',  // å·¦ã‚¯ãƒªãƒƒã‚¯
                1: 'Mouse3',  // ä¸­ã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒ›ã‚¤ãƒ¼ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼‰
                2: 'Mouse2',  // å³ã‚¯ãƒªãƒƒã‚¯
                3: 'Mouse4',  // ã‚µã‚¤ãƒ‰ãƒœã‚¿ãƒ³1
                4: 'Mouse5'   // ã‚µã‚¤ãƒ‰ãƒœã‚¿ãƒ³2
            };
            return buttonMap[button];
        }

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å–ªå¤±æ™‚ã«å…¨ã¦ã®ã‚­ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
        window.addEventListener('blur', () => {
            // Winã‚­ãƒ¼ã‚’æŠ¼ã™ã¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤±ã†å ´åˆãŒã‚ã‚‹ãŸã‚ã€å…¨ã‚­ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            pressedKeys.clear();
            document.querySelectorAll('.key.pressed').forEach(key => {
                key.classList.remove('pressed');
            });
        });

        // ã‚­ãƒ¼ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        function highlightKey(keyCode, isPressed) {
            if (!keymapData || !keymapData.layers) {
                return;
            }

            // ã‚­ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚­ãƒ¼ãƒãƒƒãƒ—ã®ã‚­ãƒ¼ã«ãƒãƒƒãƒ”ãƒ³ã‚°
            const keyMapping = {
                'KeyQ': 'Q', 'KeyW': 'W', 'KeyE': 'E', 'KeyR': 'R', 'KeyT': 'T',
                'KeyY': 'Y', 'KeyU': 'U', 'KeyI': 'I', 'KeyO': 'O', 'KeyP': 'P',
                'KeyA': 'A', 'KeyS': 'S', 'KeyD': 'D', 'KeyF': 'F', 'KeyG': 'G',
                'KeyH': 'H', 'KeyJ': 'J', 'KeyK': 'K', 'KeyL': 'L',
                'KeyZ': 'Z', 'KeyX': 'X', 'KeyC': 'C', 'KeyV': 'V', 'KeyB': 'B',
                'KeyN': 'N', 'KeyM': 'M',
                'Digit1': '1', 'Digit2': '2', 'Digit3': '3', 'Digit4': '4', 'Digit5': '5',
                'Digit6': '6', 'Digit7': '7', 'Digit8': '8', 'Digit9': '9', 'Digit0': '0',
                'Space': 'Space',
                'Enter': 'Enter',
                'Backspace': 'BS',
                'Tab': 'Tab',
                'Escape': 'Esc',
                'Delete': 'Del',
                'Minus': '-',
                'Equal': '=',
                'BracketLeft': '[',
                'BracketRight': ']',
                'Backslash': '\\',
                'Semicolon': ';',
                'Quote': "'",
                'Comma': ',',
                'Period': '.',
                'Slash': '/',
                'Backquote': '`',
                'ShiftLeft': 'LShift',
                'ShiftRight': 'RShift',
                'ControlLeft': 'LCtrl',
                'ControlRight': 'RCtrl',
                'AltLeft': 'LAlt',
                'AltRight': 'RAlt',
                'MetaLeft': 'LWin',
                'MetaRight': 'RWin',
                'OSLeft': 'LWin',
                'OSRight': 'RWin',
                'ArrowUp': 'â†‘',
                'ArrowDown': 'â†“',
                'ArrowLeft': 'â†',
                'ArrowRight': 'â†’',
                'Convert': 'Lang1',
                'NonConvert': 'ç„¡å¤‰æ›',
                'KanaMode': 'Lang2',
                'Lang1': 'Lang1',
                'Lang2': 'Lang2',
                // ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚­ãƒ¼
                'F1': 'F1', 'F2': 'F2', 'F3': 'F3', 'F4': 'F4', 'F5': 'F5', 'F6': 'F6',
                'F7': 'F7', 'F8': 'F8', 'F9': 'F9', 'F10': 'F10', 'F11': 'F11', 'F12': 'F12',
                // ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³
                'Mouse1': 'M1',
                'Mouse2': 'M2',
                'Mouse3': 'M3',
                'Mouse4': 'M4',
                'Mouse5': 'M5',
                // Shift + æ•°å­—ã‚­ãƒ¼
                'Shift+Digit1': '!',
                'Shift+Digit2': '@',
                'Shift+Digit3': '#',
                'Shift+Digit4': '$',
                'Shift+Digit5': '%',
                'Shift+Digit6': '^',
                'Shift+Digit7': '&',
                'Shift+Digit8': '*',
                'Shift+Digit9': '(',
                'Shift+Digit0': ')',
                // Shift + è¨˜å·ã‚­ãƒ¼
                'Shift+Minus': '_',
                'Shift+Equal': '+',
                'Shift+BracketLeft': '{',
                'Shift+BracketRight': '}',
                'Shift+Backslash': '|',
                'Shift+Semicolon': ':',
                'Shift+Quote': '"',
                'Shift+Comma': '<',
                'Shift+Period': '>',
                'Shift+Slash': '?',
                'Shift+Backquote': '~',
            };

            const mappedKey = keyMapping[keyCode];
            if (!mappedKey) {
                console.log('Unmapped keyCode:', keyCode);
                return;
            }

            // ã™ã¹ã¦ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§è©²å½“ã™ã‚‹ã‚­ãƒ¼ã‚’æ¢ã™
            keymapData.layers.forEach((layerBindings, layerIndex) => {
                layerBindings.forEach((binding, keyIndex) => {
                    // è¤‡æ•°ã®ãƒãƒƒãƒæ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
                    let isMatch = false;

                    if (binding.type === 'keypress' && binding.key === mappedKey) {
                        isMatch = true;
                    } else if (binding.type === 'mod-tap') {
                        // mod-tapã¯ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ã¾ãŸã¯ä¿®é£¾ã‚­ãƒ¼ã«ãƒãƒƒãƒ
                        if (binding.key === mappedKey || binding.mod === mappedKey) {
                            isMatch = true;
                        }
                    } else if (binding.type === 'layer-tap' && binding.key === mappedKey) {
                        isMatch = true;
                    } else if (binding.type === 'momentary' && binding.key === mappedKey) {
                        isMatch = true;
                    } else if (binding.type === 'mouse-key' && binding.key === mappedKey) {
                        isMatch = true;
                    }

                    if (isMatch) {
                        const keyElement = document.querySelector(`[data-layer="${layerIndex}"][data-key-index="${keyIndex}"]`);
                        if (keyElement) {
                            if (isPressed) {
                                keyElement.classList.add('pressed');
                                // ãƒ†ã‚¹ãƒˆå±¥æ­´ã«è¿½åŠ 
                                keyElement.classList.add('tested');
                            } else {
                                keyElement.classList.remove('pressed');
                                // testedã‚¯ãƒ©ã‚¹ã¯ç¶­æŒ
                            }
                        }
                    }
                });
            });
        }

        // ãƒˆãƒ©ãƒƒã‚¯ãƒœãƒ¼ãƒ« - ã‚«ãƒ¼ã‚½ãƒ«æ“ä½œã®æ¤œå‡º
        document.addEventListener('mousemove', (e) => {
            if (!trackballEnabled) return;

            // ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°å‡¦ç†
            const now = Date.now();
            if (now - lastMouseMoveTime < mouseMovementThrottle) return;
            lastMouseMoveTime = now;

            const movementX = e.movementX || 0;
            const movementY = e.movementY || 0;

            // ç´¯ç©å€¤ã‚’æ›´æ–°
            cursorX += movementX;
            cursorY += movementY;
            cursorTotal += Math.abs(movementX) + Math.abs(movementY);

            // UIã‚’æ›´æ–°
            updateCursorDisplay();
        });

        // ãƒˆãƒ©ãƒƒã‚¯ãƒœãƒ¼ãƒ« - ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ“ä½œã®æ¤œå‡º
        document.addEventListener('wheel', (e) => {
            if (!trackballEnabled) return;

            const deltaY = e.deltaY;
            const deltaX = e.deltaX;

            // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            if (deltaY > 0) {
                // ä¸‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                scrollDownCount++;
                flashScrollIndicator('down');
            } else if (deltaY < 0) {
                // ä¸Šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                scrollUpCount++;
                flashScrollIndicator('up');
            }

            // æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            if (deltaX > 0) {
                // å³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                scrollRightCount++;
                flashScrollIndicator('right');
            } else if (deltaX < 0) {
                // å·¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                scrollLeftCount++;
                flashScrollIndicator('left');
            }

            scrollTotal += Math.abs(deltaY) + Math.abs(deltaX);

            // UIã‚’æ›´æ–°
            updateScrollDisplay();
        });

        // ã‚«ãƒ¼ã‚½ãƒ«è¡¨ç¤ºã®æ›´æ–°
        function updateCursorDisplay() {
            document.getElementById('cursor-x').textContent = cursorX;
            document.getElementById('cursor-y').textContent = cursorY;
            document.getElementById('cursor-total').textContent = Math.round(cursorTotal);

            // ã‚«ãƒ¼ã‚½ãƒ«ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®ä½ç½®ã‚’æ›´æ–°ï¼ˆä¸­å¿ƒã‹ã‚‰ã®ç›¸å¯¾ä½ç½®ï¼‰
            const indicator = document.getElementById('cursor-indicator');
            const maxOffset = 80; // æœ€å¤§ç§»å‹•è·é›¢ï¼ˆpxï¼‰
            const scale = 0.1; // ã‚¹ã‚±ãƒ¼ãƒ«ä¿‚æ•°

            const offsetX = Math.max(-maxOffset, Math.min(maxOffset, cursorX * scale));
            const offsetY = Math.max(-maxOffset, Math.min(maxOffset, cursorY * scale));

            indicator.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
        }

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¡¨ç¤ºã®æ›´æ–°
        function updateScrollDisplay() {
            document.getElementById('scroll-up-count').textContent = scrollUpCount;
            document.getElementById('scroll-down-count').textContent = scrollDownCount;
            document.getElementById('scroll-left-count').textContent = scrollLeftCount;
            document.getElementById('scroll-right-count').textContent = scrollRightCount;
        }

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®ç‚¹æ»…
        function flashScrollIndicator(direction) {
            const element = document.getElementById(`scroll-${direction}`);
            element.classList.add('active');
            setTimeout(() => {
                element.classList.remove('active');
            }, 200);
        }

        // ãƒˆãƒ©ãƒƒã‚¯ãƒœãƒ¼ãƒ«çµ±è¨ˆã®ãƒªã‚»ãƒƒãƒˆ
        function resetTrackballStats() {
            cursorX = 0;
            cursorY = 0;
            cursorTotal = 0;
            scrollUpCount = 0;
            scrollDownCount = 0;
            scrollLeftCount = 0;
            scrollRightCount = 0;
            scrollTotal = 0;

            updateCursorDisplay();
            updateScrollDisplay();

            // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
            const indicator = document.getElementById('cursor-indicator');
            indicator.style.transform = 'translate(0, 0)';
        }

        // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('reset-trackball').addEventListener('click', () => {
            resetTrackballStats();
        });

        // ãƒˆãƒ©ãƒƒã‚¯ãƒœãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
        document.getElementById('open-trackball-test').addEventListener('click', () => {
            document.getElementById('trackball-popup').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–
            trackballEnabled = true;
            resetTrackballStats();
        });

        // ãƒˆãƒ©ãƒƒã‚¯ãƒœãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
        function closeTrackballPopup() {
            document.getElementById('trackball-popup').style.display = 'none';
            document.body.style.overflow = ''; // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ–
            trackballEnabled = false;
        }

        document.getElementById('close-trackball-popup').addEventListener('click', () => {
            closeTrackballPopup();
        });

        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('trackball-popup').addEventListener('click', (e) => {
            if (e.target.id === 'trackball-popup') {
                closeTrackballPopup();
            }
        });

    </script>
</body>
</html>